<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bandwidth Monitor</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .header h1 {
            color: #333;
            font-size: 2em;
            margin-bottom: 10px;
        }

        .total-bandwidth {
            display: flex;
            justify-content: space-around;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 20px;
        }

        .bandwidth-item {
            flex: 1;
            min-width: 250px;
            padding: 20px;
            border-radius: 8px;
            color: white;
        }

        .bandwidth-item.total {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .bandwidth-item.rx {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .bandwidth-item.tx {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        }

        .bandwidth-item h2 {
            font-size: 2.5em;
            margin-bottom: 5px;
        }

        .bandwidth-item p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .chart-container h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.5em;
        }

        .servers-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .servers-container h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.5em;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        th {
            background: #f5f5f5;
            font-weight: 600;
            color: #333;
        }

        tr:hover {
            background: #f9f9f9;
        }

        .status-online {
            color: #4caf50;
            font-weight: bold;
        }

        .status-offline {
            color: #f44336;
            font-weight: bold;
        }

        .error-message {
            color: #f44336;
            font-size: 0.9em;
            font-style: italic;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .last-updated {
            text-align: center;
            color: #666;
            font-size: 0.9em;
            margin-top: 10px;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.5em;
            }

            .bandwidth-item h2 {
                font-size: 2em;
            }

            .bandwidth-item p {
                font-size: 1em;
            }

            table {
                font-size: 0.9em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üåê Bandwidth Monitor</h1>
            <div class="total-bandwidth">
                <div class="bandwidth-item total">
                    <h2 id="total-bandwidth">0 B/s</h2>
                    <p>Total Bandwidth</p>
                </div>
                <div class="bandwidth-item rx">
                    <h2 id="total-rx">0 B/s</h2>
                    <p>‚Üì Inbound</p>
                </div>
                <div class="bandwidth-item tx">
                    <h2 id="total-tx">0 B/s</h2>
                    <p>‚Üë Outbound</p>
                </div>
            </div>
            <p class="last-updated">Last updated: <span id="last-updated">-</span></p>
        </div>

        <div class="chart-container">
            <h2>üìä Bandwidth History (Last 5 Minutes)</h2>
            <canvas id="bandwidthChart"></canvas>
        </div>

        <!-- Billing Summary Section -->
        <div class="header" style="background: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%);">
            <h2>üí∞ Billing Summary</h2>
            <div class="total-bandwidth">
                <div class="bandwidth-item" style="background: linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%);">
                    <h2 id="billing-capacity">0 B/s</h2>
                    <p>Total Committed Capacity</p>
                    <small>(Sum of Peaks)</small>
                </div>
                <div class="bandwidth-item" style="background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);">
                    <h2 id="billing-avg">0 B/s</h2>
                    <p>Total Daily Average</p>
                    <small>(Sum of 24h Avg)</small>
                </div>
                <div class="bandwidth-item" style="background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 99%, #fecfef 100%);">
                    <h2 id="billing-dominant">-</h2>
                    <p>Dominant Server</p>
                    <small>(Highest Usage)</small>
                </div>
            </div>
        </div>

        <div class="servers-container">
            <h2>üñ•Ô∏è Server Status & Billing Metrics</h2>
            <table>
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Status</th>
                        <th>Live RX / TX</th>
                        <th>Avg RX (24h)</th>
                        <th>Avg TX (24h)</th>
                        <th>Peak Analysis (Max + Top 3)</th>
                    </tr>
                </thead>
                <tbody id="servers-table">
                    <tr>
                        <td colspan="6" class="loading">Loading...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // Initialize Chart.js
        const ctx = document.getElementById('bandwidthChart').getContext('2d');
        const chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    {
                        label: 'Inbound (RX)',
                        data: [],
                        borderColor: '#4facfe',
                        backgroundColor: 'rgba(79, 172, 254, 0.1)',
                        fill: true,
                        tension: 0.4
                    },
                    {
                        label: 'Outbound (TX)',
                        data: [],
                        borderColor: '#43e97b',
                        backgroundColor: 'rgba(67, 233, 123, 0.1)',
                        fill: true,
                        tension: 0.4
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        position: 'top',
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return formatBytes(value) + '/s';
                            }
                        }
                    }
                },
                animation: {
                    duration: 500
                }
            }
        });

        // Format bytes to human-readable string
        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            if (i < 0) return bytes + ' B';
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Format timestamp
        function formatTimestamp(unixTimestamp) {
            const date = new Date(unixTimestamp * 1000);
            return date.toLocaleTimeString();
        }

        // Fetch metrics from API
        async function fetchMetrics() {
            try {
                const response = await fetch('/api/metrics');
                const result = await response.json();
                
                if (result.success && result.data) {
                    updateDashboard(result.data);
                }
            } catch (error) {
                console.error('Error fetching metrics:', error);
            }
        }

        // Update dashboard with new data
        function updateDashboard(data) {
            // Update total bandwidth
            const totalRx = data.totalRx || 0;
            const totalTx = data.totalTx || 0;
            const total = totalRx + totalTx;

            document.getElementById('total-bandwidth').textContent = formatBytes(total) + '/s';
            document.getElementById('total-rx').textContent = formatBytes(totalRx) + '/s';
            document.getElementById('total-tx').textContent = formatBytes(totalTx) + '/s';

            // Update Billing Summary
            document.getElementById('billing-capacity').textContent = formatBytes(data.grandTotalPeak || 0) + '/s';
            document.getElementById('billing-avg').textContent = formatBytes(data.grandTotalAvg || 0) + '/s';
            document.getElementById('billing-dominant').textContent = data.dominantServer || '-';

            // Update last updated time
            if (data.updatedAt) {
                const date = new Date(data.updatedAt);
                document.getElementById('last-updated').textContent = date.toLocaleString();
            }

            // Update chart
            if (data.history && data.history.length > 0) {
                chart.data.labels = data.history.map(h => formatTimestamp(h.timestamp));
                chart.data.datasets[0].data = data.history.map(h => h.totalRx);
                chart.data.datasets[1].data = data.history.map(h => h.totalTx);
                chart.update('none'); // Update without animation for better performance
            }

            // Update servers table
            if (data.servers) {
                updateServersTable(data.servers);
            }
        }

        // Update servers table
        function updateServersTable(servers) {
            const tbody = document.getElementById('servers-table');
            const serverNames = Object.keys(servers).sort();

            if (serverNames.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="loading">No servers configured</td></tr>';
                return;
            }

            tbody.innerHTML = serverNames.map(name => {
                const server = servers[name];
                const statusClass = server.online ? 'status-online' : 'status-offline';
                const statusText = server.online ? 'Online' : 'Offline';
                const errorHtml = server.error ? `<br><span class="error-message">${server.error}</span>` : '';

                // Peak Analysis Logic
                const maxPeak = Math.max(server.peakRx || 0, server.peakTx || 0);
                const peakEventsHtml = (server.peakEvents || []).map(e =>
                    `<div style="font-size: 0.85em; color: #666;">
                        üïí ${e.time}: ‚¨áÔ∏è${formatBytes(e.rx)}/s ‚¨ÜÔ∏è${formatBytes(e.tx)}/s
                    </div>`
                ).join('');

                return `
                    <tr>
                        <td>
                            <strong>${server.name}</strong><br>
                            <small style="color: #666;">${server.ip}</small>
                        </td>
                        <td class="${statusClass}">${statusText}${errorHtml}</td>
                        <td>
                            <div style="color: #4facfe;">‚¨áÔ∏è ${formatBytes(server.rx || 0)}/s</div>
                            <div style="color: #43e97b;">‚¨ÜÔ∏è ${formatBytes(server.tx || 0)}/s</div>
                        </td>
                        <td>${formatBytes(server.avgRx24h || 0)}/s</td>
                        <td>${formatBytes(server.avgTx24h || 0)}/s</td>
                        <td>
                            <strong>Max: ${formatBytes(maxPeak)}/s</strong>
                            <div style="margin-top: 5px; border-top: 1px dashed #ccc; padding-top: 5px;">
                                ${peakEventsHtml || '<span style="color:#999">No peak data</span>'}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Initial fetch
        fetchMetrics();

        // Auto-refresh every 2 seconds
        setInterval(fetchMetrics, 2000);
    </script>
</body>
</html>